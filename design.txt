archmap internals
=================

See functionality.txt for user-facing usage, CLI options, and output format.

================================================================================
Skeleton parsing (main.c — 1584 lines)
================================================================================

Tree-sitter query
    A single query matches eight top-level node types:
        function_definition  struct_specifier  enum_specifier  type_definition
        declaration          preproc_def       preproc_function_def  preproc_include

    Each file is parsed exactly once (collect_file). The match loop applies
    three filters and caches resolved #include paths on file_entry:
      1. Dedup: skip struct_specifier/enum_specifier whose parent is
         type_definition or declaration (already captured by that parent).
      2. Scope: keep only file-scope nodes (ancestor walk hits
         translation_unit before any function_definition/compound_statement).
      3. Preproc: skip nodes inside dead #ifdef/#if branches.

Skeleton text generation
    skeleton_text() replaces function bodies with semicolons, truncates
    large initializers to { ... }, collapses struct/union/enum to single
    lines. Sequential enums (no explicit values, or only first has value)
    get compact comma-separated format.

    Postprocessing pipeline (postprocess_skeleton):
      strip_qualifiers -> strip_trailing_attribute -> strip_comments ->
      normalize_whitespace -> join_continuation_lines ->
      collapse_blank_lines -> collapse_to_single_line

Preprocessor branch selection
    should_skip_preproc walks ancestors upward:
    - preproc_ifdef: eval_ifdef checks "name" field against -D defines
    - preproc_if: eval_preproc_if handles defined/!defined/0/1
    - preproc_elif/preproc_elifdef: same logic for elif chains
    - Unknown macros treated as undefined: #ifdef X skips primary, emits
      #else (correct for include guards without -D flags)

Forward declaration deduplication
    SAHA hash set (g_tags) tracks struct/enum/union tag names with full
    definitions (body/field_declaration_list). register_full_tags recursively
    walks each captured node. is_bare_forward_decl checks for absence of
    body and declarator. Bare forward declarations whose tag is in the set
    are suppressed at print time.

Call graph extraction
    When -c is active, collect_callees recursively walks each
    function_definition's compound_statement for call_expression nodes.
    Callees deduplicated per function via add_callee.

Sidecar discovery
    Searches for .archmap starting from the common prefix directory of all
    processed files, then walks upward to /. Glob matching uses relative
    paths (after common prefix stripping).

Directory walking
    fts(3) with FTS_PHYSICAL | FTS_NOCHDIR. Skip rules: dotfiles/dotdirs,
    and below root: build, vendor, node_modules, third_party.

    BFS mode (-d): seed visited set from fts walk, then iterate: collect_file
    caches resolved includes on file_entry. BFS loop reads cached includes,
    appends newly-seen realpath entries. Each file parsed exactly once.

================================================================================
Git caching (git_cache.c — 510 lines)
================================================================================

Parse results keyed by git blob OID (SHA-1 of file contents). Identical
files have identical OIDs — unchanged files skip re-parsing across runs.

Binary format: magic "AMAP", version 1, 32-byte header. FNV-1a hash of
options string invalidates cache when CLI flags change.

Deep-copy serialization: all strings and nested structures (symbols,
includes, callees) are strdup'd into cache_entry to avoid dangling
pointers from temporary parse state.

================================================================================
Perf pipeline (perf_analysis.c — 4287 lines)
================================================================================

Pipeline: build -> profile (direct perf_event_open + libdwfl + capstone) ->
skeleton cross-reference -> compact report

Single execution per profile: counters, sampling, and topdown all run
simultaneously on the same fork+exec child via perf_event_open(). No
external perf binary needed.

Symbol resolution: libdwfl resolves sample IPs to function names and
source locations. Capstone disassembles hot instruction addresses.

Skeleton cross-reference: hot function names matched against tree-sitter
skeleton (parsed via collect_file) to show signatures, call edges, callers.

A/B comparison: profiles both binaries with --runs N (default 5), computes
per-metric mean/stddev, Welch's t-test for statistical significance, then
diffs every output section.

Memory architecture
    Arena bump allocator:
        2 MiB hugepage-backed blocks (mmap MAP_HUGETLB with THP fallback).
        All persistent profile data (function names, instruction text, source
        paths, growing arrays) allocated from prof->arena. Single
        arena_destroy() frees everything at cleanup.

        arena_realloc: extends in-place when ptr is the most-recent bump
        allocation (fast path for doubling arrays). Falls back to
        alloc+memcpy; old block wasted but bounded by doubling strategy.

        arena_save/arena_reset: watermark pattern for loop-scoped
        temporaries (symres scratch, mca scratch). Avoids malloc/free
        churn in hot loops.

    String interning:
        Wyhash-based intern table (prof->strings). All repeated strings
        (function names, source paths) interned once. Linear probing,
        80% load factor, arena-backed string storage. Separate calloc'd
        slot array (needs zeroing for rehash).

    Remaining malloc sites (~13): run_cmd() buffers with independent
    lifetimes, join_argv() (called before arena exists), large temporaries
    freed within function scope (buckets, ip_buckets, func_bytes),
    intern table slots. All xmalloc/xcalloc/xrealloc abort on OOM.

Struct packing:
    symbol: is_fwd_decl/section/cap_idx as bitfields (56 -> 48 bytes)
    perf_opts: mode/flag fields as bitfields (96 -> 72 bytes)
    Struct field reordering to eliminate padding holes.

================================================================================
Hash table implementations
================================================================================

SAHA (hmap_avx512.h/c — 92+579 lines)
    Used in main.c for g_tags (forward decl dedup).
    SIMD-Accelerated Hash Array. 4-tier design by key length:
      Tier 1: <=8B (inline u64)
      Tier 2: <=16B (inline key16: u64 lo, hi)
      Tier 3: <=24B (inline key24: u64 a, b, c)
      Tier 4: >24B (arena-backed: hash+offset+length triplet)
    64-slot SIMD groups, wyhash, 7-bit h2 metadata (h2 | 0x80 sentinel),
    87.5% load factor. AVX-512 _mm512_cmpeq_epi8_mask for group probing.

simd_map64.h (240 lines) — uint64_t hash set, test/bench only
    Zero-metadata direct-key design. 8-wide groups (one cache line).
    SIMD compares all 8 keys at once — zero false positives, no
    metadata bytes. Key=0 empty sentinel. CRC32 hash. Backshift deletion
    (no tombstones). Unified op function for mixed workloads (eliminates
    3-way switch dispatch misprediction). Dual backend: AVX-512 (1 instr
    per group) or AVX2 (5 instr per group, same 8-bit mask interface).

avx_map64s.h (206 lines) — uint64_t hash set with 16-bit h2 + sentinel
    31 data slots + 1 overflow sentinel per group. 15-bit h2 gives
    1/32768 false positive rate (256x better than 7-bit). Sentinel
    eliminates SIMD empty check on contains hot path. Interleaved layout:
    64B metadata + 256B keys per group.

avx_map128s.h (343 lines) — 128-bit key hash set with sentinel
    Same sentinel architecture as avx_map64s but for 128-bit keys.
    320B interleaved groups. Chained CRC32 hash (two 32-bit halves).
    Prefetch pipelining: 1.9-5.4x speedup, 112M ops/sec.

avx_phf64.h (179 lines) — perfect hash function for uint64_t
    Fixed-size, no insertion/deletion after construction.

verstable.h (2069 lines) — vendored generic hash table
    Template-based C hash table. Tombstone-free deletions via cyclic
    shift. Used as comparison baseline in benchmarks.

Intern table (perf_analysis.c lines 149-278) — string dedup
    Wyhash with linear probing. Separate calloc'd slot array,
    arena-backed string storage. 80% load factor.

================================================================================
Source file map
================================================================================

Core:
    main.c              1584 lines  Skeleton CLI, tree-sitter parsing, caching
    perf_analysis.c     4287 lines  Perf pipeline, arena, interning, reporting
    git_cache.c          510 lines  Incremental git blob OID cache
    hmap_avx512.c        579 lines  SAHA implementation

Headers:
    perf_analysis.h      161 lines  Shared structs (symbol, file_entry, perf types)
    git_cache.h           34 lines  Cache API (open/lookup/store/close)
    hmap_avx512.h         92 lines  SAHA API, tier dispatch macros

Hash table headers (standalone, test/bench use):
    simd_map64.h         240 lines  uint64_t direct-key hash set (AVX-512/AVX2)
    avx_map64s.h         206 lines  uint64_t sentinel hash set
    avx_map128s.h        343 lines  128-bit sentinel hash set
    avx_phf64.h          179 lines  Perfect hash function
    verstable.h         2069 lines  Generic hash table (vendored)

Total: ~10,283 lines (excluding vendor/, tests, benches)

================================================================================
Build system
================================================================================

Single-invocation whole-program compilation: main.c + perf_analysis.c +
git_cache.c + hmap_avx512.c + tree-sitter lib.c + tree-sitter-c parser.c
compiled together. -fwhole-program makes every symbol except main()
internal, enabling cross-module inlining and dead code elimination across
tree-sitter internals.

Compiler flags: -O3 -march=native -flto -fomit-frame-pointer
    -fno-asynchronous-unwind-tables -fno-unwind-tables -fno-stack-protector
    -fipa-pta -fmerge-all-constants -DNDEBUG -mavx512f -mavx512bw
    -Wall -Wextra -std=gnu11

Vendored sources: tree-sitter v0.26.5 (runtime), tree-sitter-c v0.24.1
(grammar). Fetched on first build via curl from GitHub release tarballs.

System libraries: libgit2, libdw, libelf, capstone, libpfm4, libm
